---
title: 'Python и DevOps: ключ к автоматизации Linux'
created: '2022-08-29T13:43:07.472Z'
modified: '2022-09-01T12:39:08.919Z'
---

# Python и DevOps: ключ к автоматизации Linux
## Принципы DevOps
Система CI собирает программное обеспечение в **бинарный файл или образ Docker** и выполняет **модульное тестирование**. Система CD развертывает собранные CI артефакты в **целевой среде**.

- Двустороннее сотрудничество специалистов разработки и эксплуатации; команде эксплуатации нужны навыки разработчиков, команде разработчиков - навыки эксплуатации.
- Люди не должны участвовать в развертывании ПО на постоянной основе. Полный цикл задач эксплуатации занимает минуты-часы, реализованы конвейеры **CI/CD**.
- **GitOps**.
- Не автоматизировано - значит сломано.
- **Микросервисы** > монолитная архитектура.
- **Агрегированное журналирование**: как на уровне приложения, так и на уровне среды. Исключения всегда должны отправляться в **централизованные журналы** для разработки **эвристических правил отладки**. Кроме того, наличие отдельного сервера позволяет обеспечить их целостность и защиту от отдельных администраторов.
- Использование облаков как реализация **принципа сравнительного преимущства**. 
- Реализация **отказоустойчивости**: сбой сервиса **рано или поздно произойдет**, и необходимо сократить ручное вмешательство при восстановлении, а также обеспечить **мониторинг**.

## Мониторинг и журналирование

Утилиты мониторинга используют UDP, потому что **TCP-соединения блокируются до получения ответа**.
Prometheus подходит для **краткосрочных и часто меняющихся временных данных**, а Graphite для данных, **собранных за большой промежуток времени**.

Для синтаксического разбора журналов использовать ELK.


## Траблшутинг
Если информация, необхдимая для дебага не отображается в логах, можно использовать команду `strace` и посмотреть системные вызовы.
## Python

`http.server` можно использовать только для тестирования, поскольку он не умеет обрабатывать сразу несколько запросов.

### Реактивные библиотеки CLI
Ускорить написание консольных приложений позволяет переход с `argparse` на `fire` или `click`. Первый реализован благодаря интроспекции кода, второй посредством декораторов. `fire` требует от проекта ООП и не позволяет вручную править справку по командам.
### Обход JIT
Для решения проблем с быстродействием используется динамический компилятор `Numba`, позвляющий обойти JIT и использовать многопоточность:
```
@numba.jit(nopython=True) # или parallel=True
def factorial(x, n):
    if n:
        return factorial(x, n - 1) * x
    return 1
```
### Использование Python вместе с Bash

Python из Bash можно запускать при помощи флага `-c` и функции `exec()`, аргументы которой можно предварительно закодировать в base64.
```
try() {
  python -c "
exec('''
try: 
    import ${1} as _
    print(_.__file__)
except:
    print('Module not found')
''')"
}
```
### Создание пакетов

#### PyPi

Для создания пакета используется `setuptools`, для загрузки на PyPi - `twine`.
В файле `setup.py` импортируются функции `setup`, инициализирующая описание пакета и `find_packages`, автоматически находящую файлы Python. В `setup` можно указать **trove classifiers**, содержащие ЯП, лицензию, целевую ОС и др.

Для реализации локального репозитория рекомендуется использовать `devpi`.

#### Debian
Использовать `dch` из `devscripts` для создания changelog пакета `.deb`. Для генерации двоичного файла использовать `debuild` со встроенным линетром `lintian`. Локальный репозиторий можно создать при помощи `reprepro`.

#### RPM
Требует только файла `spec` и утилиту `rpmbuild`.

## Заметки

- [Гайды AWS](https://aws.amazon.com/whitepapers/?whitepapers-main.sort-by=item.additionalFields.sortDate&whitepapers-main.sort-order=desc&awsf.whitepapers-content-type=*all&awsf.whitepapers-tech-category=*all&awsf.whitepapers-industries=*all&awsf.whitepapers-business-category=*all&awsf.whitepapers-global-methodology=*all)




